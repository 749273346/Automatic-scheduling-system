# 智能排班系统开发文档

## 一、 系统概述
本系统是一款专为电力工区设计的智能排班软件，旨在简化排班流程，实现“按周循环、规则驱动”的自动化排班。系统摒弃了复杂的算法推演，采用直观的**“固定+轮班+循环填充”**策略，结合 Apple 风格的现代化 UI 设计，提供极致的用户体验。

## 二、 核心功能
1.  **按周循环排班**：以“周”为基本单位，定义每周七天的排班模板。
2.  **灵活的排班模式**：
    *   **固定模式**：指定某人固定在每周几值班（如周二/周四）。
    *   **轮班模式**：支持单双周轮替（如单周A/双周B），适用于周五等特殊时段。
    *   **循环填充**：剩余空缺自动从“循环池”中按顺序指派，确保公平。
    *   **跟随周六**：支持周日值班人员自动跟随周六，实现周末连班。
3.  **智能状态记忆**：系统自动记录循环池的指派进度，确保下一次排班能无缝衔接。
4.  **现代化 UI**：采用 Apple 风格设计，卡片式布局、动态交互，操作简单直观。
5.  **数据交互**：支持人员名单管理、排班表导出及统计分析。

## 三、 核心排班逻辑

### 1. 规则驱动 (Rule-Based)
系统不再依赖复杂的权重评分，而是严格遵循用户配置的规则：
- **优先级**：固定人员 > 轮班人员 > 跟随周六 > 循环填充。
- **冲突处理**：若某天已配置固定人员，则跳过循环填充。

### 2. 四大排班模式
- **固定人员 (Fixed)**：
    - 适用于有固定值班习惯的人员。
    - 规则：每周X必须是用户A。
- **轮班模式 (Rotation)**：
    - 适用于需要定期轮换的岗位。
    - 规则：以设定日期为基准，计算单双周。单周派用户A，双周派用户B。
- **跟随周六 (Follow Saturday)**：
    - 适用于周末连班场景。
    - 规则：周日的人员直接复用周六的人员。
- **循环填充 (Loop)**：
    - 适用于填补剩余空缺。
    - 规则：维护一个全局“循环池”列表和“当前指针”。每天需要填补时，从池中取出下一位，指针后移。指针位置持久化保存。

### 3. 状态持久化
- **规则存储**：`schedule_rules.json` 存储每周的模板配置。
- **状态存储**：`schedule_state.json` 存储循环池的当前索引 (Loop Index)，保证跨周、跨次排班的连续性。

## 四、 技术实现方案

### 1. 技术栈
- **语言**：Python 3.x
- **GUI框架**：PyQt5 (重构为现代化 Apple 风格 UI)
- **数据存储**：
    - 规则/状态：JSON 文件 (轻量级、易读)
    - 基础数据：SQLAlchemy + SQLite (人员、历史排班)
- **核心逻辑**：基于规则的确定性生成器 (Deterministic Generator)

### 2. 排班流程
1.  **加载规则**：读取 `schedule_rules.json` 获取每周配置。
2.  **计算周次**：根据基准日期计算当前是单周还是双周。
3.  **逐日生成**：
    - **Mon-Sun**：遍历每一天。
    - **检查锁定**：若该日已有手动锁定的排班，跳过。
    - **应用规则**：根据当日配置的模式（固定/轮班/跟随/循环）确定人员。
    - **更新状态**：若是循环模式，更新内存中的 Loop Index。
4.  **保存结果**：将生成的排班写入数据库，并更新 `schedule_state.json` 中的 Loop Index。

## 五、 版本历史与更新记录

### 2026-01-04 核心重构 (New)
- **全新排班引擎**：废弃旧的回溯算法，启用基于“周模板”的规则引擎。
- **UI 全面重设计**：
    - 引入 **Apple 风格** 界面：圆角卡片、阴影效果、极简配色。
    - 新增 **可视化规则配置**：通过点击卡片配置每天的排班模式。
    - 优化 **排班设置**：整合固定、轮班、循环池配置于同一界面。
- **逻辑变更**：
    - 移除“分级策略”（Level 1/2/3）。
    - 移除“期望搭档”与复杂权重。
    - 新增“循环池”与“状态记忆”功能。

### 2024-12-30 功能增强 (Archive)
- **期望排班搭档**：新增一级人员"带人"功能。
- **打包发布**：优化构建脚本。

---
*文档生成日期：2026-01-04*
