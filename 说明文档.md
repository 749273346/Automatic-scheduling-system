# 智能排班系统开发文档

## 一、 系统概述
本系统是一款专为电力工区设计的智能排班软件，旨在解决复杂的人员分级、轮班规则及偏好管理问题。系统基于回溯算法（Backtracking），结合严格的分级策略，实现了一键自动化排班与Excel数据交互。

## 二、 核心功能
1.  **自动化排班**：支持一键生成本月/本年排班表，内置智能冲突检测。
2.  **人员分级管理**：支持一级（固定）、二级（优先）、三级（普通）三类人员的分层调度。
3.  **复杂轮班规则**：支持定期轮班（单双周）、指定搭档互斥、非轮班日共存等高级逻辑。
4.  **偏好设置**：支持设置期望值班日、不可值班日期、节假日回避及期望搭档。
5.  **数据交互**：支持Excel人员名单导入、排班表导出。
6.  **可视化界面**：直观的日历视图，支持拖拽调整、颜色标记及统计报表。

## 三、 核心排班逻辑

### 1. 人员分级策略 (Tiered Scheduling)
系统严格按照以下优先级进行排班：

-   **一级人员 (Level 1)**：
    -   **定义**：关键岗位或特定需求人员，拥有**绝对优先权**。
    -   **识别**：手动指定为"一级"，或**只要设置了"期望值班日"且未指定其他等级，系统自动推断为一级**。
    -   **排班规则**：
        -   **固定值班**：严格按照其"期望值班日"（如周二/周四）进行安排。
        -   **豁免权**：不受每周最大班次（MAX_SHIFTS）、周末连班限制等软性约束的影响。
        -   **排班策略**：采用 **"先全排后修剪" (Fill-then-Prune)** 策略。先无视冲突将所有一级人员排入其期望日，随后运行轮班规则剔除轮班日不该出现的人员，确保非轮班日（如周一/三）正常共存，轮班日（如周五）严格互斥。

-   **二级人员 (Level 2)**：
    -   **定义**：骨干人员，优先级高于普通员工。
    -   **排班规则**：
        -   在满足一级人员后的空缺中优先安排。
        -   内部追求排班数量均衡。
        -   权重极高（-5,000,000分），确保在三级人员之前被填满。

-   **三级人员 (Level 3)**：
    -   **定义**：普通员工，用于填补剩余空缺。
    -   **排班规则**：
        -   仅在二级人员不足以覆盖班次时启用。
        -   内部追求排班数量均衡，尽量满足偏好（Bonus分）。

### 2. 期望排班搭档 (Preferred Partners)
-   **功能**：允许一级人员指定期望的二级/三级搭档。
-   **逻辑**：算法在调度二级/三级人员时，若当天已有一级人员值班，会检查其期望搭档列表。
-   **权重**：若候选人在在岗一级人员的期望列表中，给予极高权重加成（-6,000,000起），使其优先级超越普通二级人员，实现"带人"排班。

### 3. 轮班与互斥
-   **定期轮班**：支持"单周/双周"轮替（如A单周值班，B双周值班）。
-   **互斥逻辑**：在指定的轮班日（如周五），系统强制保证同一组轮班人员中仅有一人值班；在非轮班日，两人可同时在岗。
-   **自我纠错**：算法具备鲁棒性，若前置步骤错误安排了互斥人员，后续步骤会自动检测并移除。

## 四、 技术实现方案

### 1. 技术栈
-   **语言**：Python 3.x
-   **GUI框架**：PyQt5 (界面美化、自定义组件)
-   **数据库**：SQLAlchemy + SQLite (本地轻量级存储)
-   **算法**：Backtracking (回溯法) + Heuristic Search (启发式搜索)

### 2. 排班流程
1.  **初始化**：加载历史数据，计算均衡性指标。
2.  **一级填充 (Level 1 Fill)**：遍历一级人员，按其期望日强制排班。
3.  **轮班修剪 (Rotation Prune)**：检查所有轮班规则，移除轮班日冲突人员。
4.  **特殊规则 (FG/H)**：应用遗留的F/G/H特殊规则（如需）。
5.  **回溯填充 (Backtracking)**：
    -   按日期（周一至周日）和班次（早/晚）递归搜索。
    -   **候选人评分**：
        -   一级人员：-10,000,000 (已固定，通常不参与此步，除非补位)
        -   二级人员：-5,000,000
        -   三级人员：0
        -   均衡性惩罚：+ (历史总数 - 平均数) * 100
        -   周末惩罚：+ (周末历史总数) * 500
        -   偏好奖励：-500
        -   期望搭档奖励：-6,000,000+
    -   选择分数最低（优先级最高）的合法候选人填入。

## 五、 版本历史与更新记录

### 2026-01-04 逻辑优化
-   **一级人员推断优化**：修复了用户设置了期望值班日但未显式指定"一级"导致被降级为"三级"的问题。现在只要设置了期望值班日，系统默认视为一级人员，确保固定排班生效。

### 2024-12-30 功能增强
-   **期望排班搭档**：新增一级人员"带人"功能，支持指定期望的二级/三级搭档。
-   **打包发布**：优化构建脚本，解决中文路径问题，生成标准安装包。
-   **UI优化**：合并偏好设置页签，调整排班表字体与间距。

### 2024-12-29 核心重构
-   **Fill-then-Prune策略**：重构一级人员排班逻辑，完美解决轮班日与非轮班日共存问题。
-   **绝对优先权**：移除一级人员的所有软性限制（数量/连班），确保"排了就是多少"。
-   **严格分级**：引入层级阻断式权重，确保"先二级后三级"的填充顺序。
-   **交互优化**：移除分步排班按钮，统一为"一键排班"（内部保留分步逻辑）。

---
*文档生成日期：2026-01-04*
