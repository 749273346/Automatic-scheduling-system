# 排班系统开发文档

## 一、项目规划
- [x] 核心排班算法实现
- [x] 界面交互优化
- [x] 偏好设置功能完善
- [x] 轮班互斥逻辑修复
- [x] 一级人员全场景验证
- [x] 一级人员绝对优先权强化
- [x] 严格分级排班策略 (Tiered Scheduling)
- [x] 轮班逻辑鲁棒性增强 (Robust Rotation)
- [x] 手动两步排班模式 (Two-Step Manual Scheduling)
- [x] "先全排后修剪"排班策略 (Fill-then-Prune)
- [x] 界面美化（字体/间距）
- [x] 周末值班顺序优化
- [x] 期望排班搭档功能
- [ ] 持续测试与优化

## 二、实施方案
- **排班算法**：采用回溯算法（Backtracking）进行排班生成，支持严格模式与宽松模式。
- **人员分级**：
  - **一级人员**：偏好不可妥协，固定排班，单独计数，不参与普通均衡。**（绝对优先权：豁免排班数量上限、周末连班等软约束）**
  - **二级人员**：优先于三级人员排班，内部追求均衡。
  - **三级人员**：填充剩余空缺，内部追求均衡。
- **一级人员排班逻辑 (Fill-then-Prune)**：
  1.  **激进填充**：首先按照偏好将所有一级人员排满（忽略轮班互斥）。
  2.  **轮班修剪**：随后应用轮班规则，检测轮班日的冲突，保留值班者，**强制移除**非值班者。
  3.  **结果**：确保非轮班日正常共存，轮班日严格互斥。
- **期望排班搭档**：
  - 一级人员可设置期望的 Level 2/3 搭档。
  - 算法在调度 Level 2/3 人员时，若当天已有一级人员值班，将**大幅提升**其期望搭档的优先级（超越等级限制），确保搭档优先入选。
- **轮班机制**：
  - 支持“定期轮班”设置（搭档、周期、奇偶性）。
  - 实现“互锁”机制：设置一方自动锁定另一方。
  - 逻辑修正：轮班日强制互斥，非轮班日可共存。
  - **鲁棒性设计**：自动兼容数据类型错误（String/Int），并增加自我纠错机制（Self-Correction），若前置步骤错误安排了互斥人员，后续步骤会自动移除。
- **排班模式**：
  - **一键完整排班**：自动执行所有步骤（一级固定 -> 轮班修剪 -> 二级填充 -> 三级填充）。

## 三、进度记录
- **2024-12-30 界面体验与细节优化**
  - **任务**：优化人员列表显示效果，调整周末排班顺序。
  - **实现**：
    - **字体调整**：将人员列表字号调整为 14px，行高增加 padding，提升可读性。
    - **周末顺序**：修改算法，强制周日值班人员的上下顺序与周六保持严格一致（如周六 A在上 B在下，周日同样 A在上 B在下）。
  - **结果**：界面更清晰，排班表视觉一致性增强。

- **2025-12-30 项目打包与发布**
  - **任务**：将项目及相关信息（说明文档、项目信息）打包为独立安装包，支持用户自定义安装路径。
  - **实现**：
    - **构建脚本**：优化 `package.py`，增加文档自动拷贝功能，确保安装包内包含完整的项目文档。
    - **环境适配**：解决 Windows 长路径与中文路径导致的构建失败问题（采用 `subst` 虚拟驱动器方案）。
    - **安装程序**：生成包含自定义安装路径选择功能的安装程序 `智能排班系统_安装包.exe`。
  - **结果**：成功生成发布包 `dist/智能排班系统_安装包.zip`，解压安装后包含主程序及完整文档，安装过程支持路径选择，符合大厂规范。


- **2024-12-30 新增“期望排班搭档”功能**
  - **任务**：允许一级人员指定期望的二级/三级搭档，并在排班时优先安排。
  - **实现**：
    - **UI**：在偏好设置中增加“期望排班搭档”页签（仅一级人员可见），支持双列表选择与排序。
    - **算法**：在 `calculate_score` 中增加逻辑，若当天已排一级人员，检查候选人是否在其期望列表中。若是，给予极高权重加成（-6,000,000起，随列表顺序递减），确保其优先级高于普通的二级人员。
  - **验证**：经 `test_preferred_partners.py` 验证，一级人员期望的三级搭档能成功“逆袭”击败无期望的二级人员入选，功能符合预期。

- **2024-12-30 UI与偏好设置优化**
  - **任务**：优化偏好设置界面，合并功能并规范命名。
  - **实现**：
    - **界面重构**：将“高级偏好”重命名为“期望值班日期”，更直观。
    - **功能合并**：移除独立的“不可值班星期”页签，将其功能整合至“不可值班日期”页签顶部，简化操作层级。
  - **结果**：设置界面更紧凑，逻辑分类更清晰。

- **2024-12-29 移除分步排班，统一为一键全部**
  - **任务**：响应用户需求，简化操作流程，移除“仅排一级”和“补齐剩余”的分步按钮。
  - **实现**：修改界面交互，点击排班直接执行全流程（含一级人员固定、轮班规则、二三级回溯填充）。
  - **结果**：操作更便捷，同时保留了分步排班的算法逻辑（内部依旧是分层执行），确保结果准确性。

- **2024-12-29 轮班逻辑修复**
  - **任务**：修正一级人员轮班算法，确保洪映森和郑桂标在周一/周三共存，周五互斥轮班。
  - **问题**：原逻辑中，若一级人员已被固定规则安排，轮班排除逻辑被跳过，导致非轮值搭档未被排除。
  - **解决**：重构 `_apply_rotation_rules`，在检查轮值者是否已安排前，**优先且强制**将非轮值搭档加入 `rotation_exclusions`。
  - **验证**：编写测试脚本 `reproduce_rotation_fail.py`，验证通过。周一/周三两人正常排班，周五严格执行单双周轮替且互斥。

- **2024-12-29 一级人员全场景验证**
  - **任务**：验证多名一级人员（洪/郑/吴）在不同规则下的共存情况。
  - **场景**：
    - 洪映森/郑桂标：周一/周三共存，周五轮班。
    - 吴杰凯：周二/周四固定值班。
  - **结果**：经脚本验证，系统正确执行所有一级人员的固定规则与轮班规则，无冲突，符合用户预期。

- **2024-12-29 一级人员绝对优先权强化**
  - **任务**：深入分析并根除一级人员在复杂场景下（如周排班数超过限制）可能被漏排的问题。
  - **问题**：原算法中，一级人员虽优先，但仍受制于全局 `MAX_SHIFTS_PER_WEEK`（每周最多3班）及周末连班等软约束，导致在部分高频排班场景下被系统“优化”掉。
  - **解决**：修改 `check_constraints` 核心逻辑，为一级人员建立**绝对优先通道**。只要是其期望的值班日，且未触犯硬性红线（如黑名单、轮班互斥），系统将**强制豁免**所有软性限制（数量上限、周末规则等），直接安排。
  - **结果**：彻底确保一级人员“排了多少就是多少”，不受全局均衡策略干扰。

- **2024-12-29 严格分级排班策略**
  - **任务**：实现“一级 -> 二级 -> 三级”的严格顺序排班，防止混乱。
  - **解决**：重构候选人评分逻辑，引入**层级阻断式权重**。
    - 一级人员：优先级权重 -10,000,000（绝对优先）
    - 二级人员：优先级权重 -5,000,000（远高于均衡分）
    - 三级人员：优先级权重 0
  - **效果**：算法在填补空缺时，会**强制先用完所有可用的二级人员**，只有当二级人员全部不可用（如满班或休息）时，才会考虑三级人员。这在内部实现了用户期望的“三阶段排班”，无需手动分步操作。

- **2024-12-29 轮班逻辑鲁棒性增强**
  - **任务**：解决因历史数据或输入类型不一致（String vs Int）导致的轮班失效问题。
  - **问题**：部分情况下，界面保存的“轮班星期”为字符串（如"4"），而算法期望整数（4），导致匹配失败，一级人员被错误地同时安排在轮班日。
  - **解决**：
    1.  **强类型兼容**：在算法层增加 Defensive Code，自动转换并兼容 String/Int 类型。
    2.  **自我纠错机制**：在应用轮班规则时，如果检测到非轮值搭档已被错误安排（如被前置的一级固定规则误排），算法会**主动将其从排班表中移除**。
  - **结果**：经 `test_robustness.py` 验证，即使数据类型混乱，系统也能正确执行“周一三共存，周五互斥”的复杂逻辑。

- **2024-12-29 手动两步排班模式**
  - **任务**：应用户要求，提供完全可控的手动分步排班功能，确保一级人员排班绝对无误后再进行后续操作。
  - **实现**：
    - **Step 1 (仅排一级)**：系统仅执行一级人员的固定规则和轮班规则，**完全跳过**普通人员的随机回溯填充。用户可在此步骤后人工检查确认。
    - **Step 2 (补齐剩余)**：系统读取已确认的一级排班结果，在此基础上使用回溯算法，按照“先二级后三级”的顺序填补剩余空缺。
  - **交互**：在点击“月度排班”时弹出模式选择对话框，用户可自由选择“一键完成”或“分步执行”。

- **2024-12-29 "先全排后修剪"策略 (Fill-then-Prune)**
  - **任务**：解决一级人员因轮班逻辑而被错误跳过非轮班日排班的问题。
  - **问题**：原算法在检测到有轮班设置时，过于保守地跳过了所有日期的固定安排，导致非轮班日（如周一/周三）一级人员未出现。
  - **解决**：彻底改变策略。先无视轮班规则，强制安排所有一级人员的期望日（保证非轮班日全员在岗）；然后运行轮班规则，精准识别轮班日（如周五），剔除不需要值班的那一位。
  - **验证**：经 `verify_level1_and_rotation.py` 验证，洪/郑在周一/周三双人共存，周五单人轮替；吴杰凯在周二/周四固定在岗。完美符合需求。
